## 分布式文件系统存储模型及优化

### schema定义文件

```hive
CREATE DATABASE dw2024;

create external table if not exists dw2024.act
(
    movie_id   string,
    actor_uuid string
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.OpenCSVSerde'
WITH SERDEPROPERTIES (
    "separatorChar" = ",",
    "quoteChar" = '\"'
)
STORED AS TEXTFILE
LOCATION '/dw2024/Act'
tblproperties ("skip.header.line.count"="1");

create external table if not exists dw2024.actor
(
    actor_uuid string,
    actor_name string
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.OpenCSVSerde'
WITH SERDEPROPERTIES (
    "separatorChar" = ",",
    "quoteChar" = "\""
)
STORED AS TEXTFILE
LOCATION '/dw2024/Actor/'
tblproperties ("skip.header.line.count"="1");

create external table if not exists dw2024.direct
(
    movie_id      string,
    director_uuid string
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.OpenCSVSerde'
WITH SERDEPROPERTIES (
    "separatorChar" = ",",
    "quoteChar" = '\"'
)
STORED AS TEXTFILE
LOCATION '/dw2024/Direct'
tblproperties ("skip.header.line.count"="1");
create external table if not exists dw2024.director
(
    director_uuid string,
    director_name string
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.OpenCSVSerde'
WITH SERDEPROPERTIES (
    "separatorChar" = ",",
    "quoteChar" = '\"'
)
STORED AS TEXTFILE
LOCATION '/dw2024/Director'
tblproperties ("skip.header.line.count"="1");

create external table if not exists dw2024.genre
(
    genre_uuid string comment '使用UUID作为genre的ID',
    movie_id   string comment '电影ID',
    genre_name string
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.OpenCSVSerde'
WITH SERDEPROPERTIES (
    "separatorChar" = ",",
    "quoteChar" = '\"'
)
STORED AS TEXTFILE
LOCATION '/dw2024/Genre'
tblproperties ("skip.header.line.count"="1");

create external table if not exists dw2024.movie
(
    movie_id    string,
    movie_title string,
    imdb_score  float,
    review_num  int
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.OpenCSVSerde'
WITH SERDEPROPERTIES (
    "separatorChar" = ",",
    "quoteChar" = '\"'
)
STORED AS TEXTFILE
LOCATION '/dw2024/Movie'
tblproperties ("skip.header.line.count"="1");

create external table if not exists dw2024.releasedate
(
    date_uuid string,
    movie_id  string,
    year      int,
    month     int,
    day       int,
    weekday   int comment '周一为0'
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.OpenCSVSerde'
WITH SERDEPROPERTIES (
    "separatorChar" = ",",
    "quoteChar" = '\"'
)
STORED AS TEXTFILE
LOCATION '/dw2024/ReleaseDate'
tblproperties ("skip.header.line.count"="1");

create external table if not exists dw2024.version
(
    version_uuid string,
    movie_id     string,
    edition      string,
    language     string
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.OpenCSVSerde'
WITH SERDEPROPERTIES (
    "separatorChar" = ",",
    "quoteChar" = '\"'
)
STORED AS TEXTFILE
LOCATION '/dw2024/Version'
tblproperties ("skip.header.line.count"="1");

CREATE EXTERNAL TABLE IF NOT EXISTS dw2024.actor_actor (
    LEFT_PERSON_ID STRING,
    RIGHT_PERSON_ID STRING,
    MOVIE_ID STRING
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.OpenCSVSerde'
WITH SERDEPROPERTIES (
    "separatorChar" = ",",
    "quoteChar" = '\"'
)
STORED AS TEXTFILE
LOCATION '/dw2024/ActorActor'
tblproperties ("skip.header.line.count"="1");

CREATE EXTERNAL TABLE IF NOT EXISTS dw2024.director_actor (
    MOVIE_ID STRING,
    ACTOR_ID STRING,
    DIRECTOR_ID STRING
)
ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.OpenCSVSerde'
WITH SERDEPROPERTIES (
    "separatorChar" = ",",
    "quoteChar" = '\"'
)
STORED AS TEXTFILE
LOCATION '/dw2024/DirectorActor'
tblproperties ("skip.header.line.count"="1");



```

##### 优化

1. 将关系型数据库中的视图存储为实际的表，这样不仅可以复⽤之前的代码，还可以节省演员和演员以及演员和导演之间的join操作，加快查询速度

2. 建⽴与关系型数据库相同的数据库表，通过冗余字段避免join操作，并建⽴了相同的索引以提⾼查询效率

3. 建⽴外部表用于管理存储在数据库外部的数据，数据库中只存储元数据，⽽将实际数据存储到⽂件系统中，这种⽅式允许直接在数据所在位置进⾏查询处理，减少了数据移动的需要，避免其数据移动成为查询瓶颈，从⽽提升查询效率。